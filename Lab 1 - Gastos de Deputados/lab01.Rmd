---
title: "Análise de Gastos de Deputados"
author: "Hugo Gabriel"
date: "25 de outubro de 2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)

library(tidyverse)
library(plotly)
library(wordcloud)
library(rgdal)
library(leaflet)
library(RColorBrewer)
```

```{r}
ceap <- read.csv("dadosCEAP.csv")
ceap$valorGlosa <- as.numeric(sub(",", ".", ceap$valorGlosa, fixed = TRUE)) 
```

### 1 - Quais os partidos que mais fazem uso da CEAP? Quais os partidos que menos fazem uso? Mesmas perguntas conisderando valores em R$.

```{r}
partidos <- ceap %>%
  group_by(sgPartido) %>%
  summarise(n = n())

partidos %>%
  plot_ly(x=~reorder(sgPartido, n), y=~n, type = "bar") %>%
  layout(title = "Uso da CEAP por partido",
         xaxis = list(title = ""),
         yaxis = list(title = "Número de usos da cota"))

```

O gráfico deixa claro que o partido que usa a cota mais vezes é o __PT__ com aproximadamente 130 mil usos. Por outro lado os partidos __PT do B, e PMN__ usaram a CEAP 50 e 61 vezes respectivamente.

```{r}
partidos_rs <- ceap %>%
  group_by(sgPartido) %>%
  summarise(total = sum(valorLíquido))

partidos_rs %>%
  plot_ly(x=~reorder(sgPartido, total), y=~total, type="bar") %>%
  layout(title = "Uso da CEAP por partido",
         xaxis = list(title = "Partido"),
         yaxis = list(title = "Valor (em R$) gastos na cota")) 
```

O comportamento para o valor gasto é bastante similar ao visto anteriomente para a frequência, como os que menos gastam temos ainda __PT do B e PMN__ mas o partido que mais gasta é o __PMDB__ que era o segundo em número de usos da CEAP.

### 2 - Quais os tipos de despesa mais comuns no uso da CEAP? Mesma pergunta considerando valores em R$.

```{r}
ceap %>%
  group_by(tipoDespesa) %>%
  summarise(n = n()) %>%
  plot_ly(y=~reorder(tipoDespesa, n), x=~n) %>%
  layout(margin = list(l = 500),
         yaxis = list(title = ""))

```

As despesas mais comuns são com __Emissão de bilhete aéreo, Combustíveis e Telefonia__.

```{r}
ceap %>%
  group_by(tipoDespesa) %>%
  summarise(total = sum(valorLíquido)) %>%
  plot_ly(x=~total, y=~reorder(tipoDespesa, total), type="bar") %>%
  layout(margin = list(l = 500),
         yaxis = list(title = ""))

```

As que mais demandam dinheiro da cota parlamentar são a __Divulgação da atividade parlamentar, Emissão de bilhete aéreo e locação de veículos__.

### 3 - Levando em conta o estado pelo qual o deputado se elegeu, quais os estados que mais fazem uso da CEAP? Quais os que menos fazem uso? Mesmas perguntas considerando gastos em R$. Por que você acha isso?

```{r results=FALSE}
mapa <- readOGR("mapa/BRUFE250GC_SIR.shp")
```


```{r}
mapa@data$sgUF <- c("AC", "AL", "AP", "BA", "CE", "DF", "ES", "GO", "MA", "MT", "MS", "MG", "PA", "PB", "PE", "PI", "RJ", "RN", "RS", "RR", "SC", "SP", "SE", "TO", "PR", "RO", "AM")

ceap_estado <- ceap %>%
  group_by(sgUF) %>%
  summarise(valor_gasto = sum(valorLíquido),
            n_gastos = n())

mapa@data <- mapa@data %>%
  left_join(ceap_estado)
```


```{r}
colors = colorNumeric('OrRd', mapa@data$n_gastos)

mapa %>%
  leaflet() %>%
  addProviderTiles(providers$Esri.WorldGrayCanvas) %>%
  addPolygons(opacity = 0.5,
              weight = 1,
              fillColor = colors(mapa@data$n_gastos),
              fillOpacity = 1,
              color = "black",
              label = paste(mapa@data$NM_ESTADO),
              popup = paste(mapa@data$NM_ESTADO, "</br>",
                            "Número de usos da cota: ", mapa@data$n_gastos)) %>%
  addLegend(position = "bottomright", pal = colors, values = mapa@data$n_gastos,
            title = "CEAP por estado - Frequência",
            opacity = 1, na.label = "0")
```

O gráfico acima considera o quantidade de vezes que a CEAP é utilizada e nele podemos perceber que __São Paulo__ é o estado que mais concentra parlamentares usando a cota, seguido por _Minas Gerais_.

É evidente ainda que os estados do _Centro-Oeste e do Norte_ usam com menos frequência a cota parlametar.

```{r}
colors = colorNumeric('OrRd', mapa@data$valor_gasto)

mapa %>%
  leaflet() %>%
  addProviderTiles(providers$Esri.WorldGrayCanvas) %>%
  addPolygons(opacity = 0.5,
              weight = 1,
              fillColor = colors(mapa@data$valor_gasto),
              fillOpacity = 1,
              color = "black",
              label = paste(mapa@data$NM_ESTADO),
              popup = paste(mapa@data$NM_ESTADO, "</br>",
                            "Valor gasto: R$", mapa@data$valor_gasto)) %>%
  addLegend(position = "bottomright", pal = colors, values = mapa@data$valor_gasto,
            title = "CEAP por estado - Valor gasto (R$)",
            opacity = 1, na.label = "0")
```

Quando lidamos com valor gasto, que é o exibido na visualização acima, identificamos comportamento similar ao descrito na análise de quantidade de uso; __São Paulo__ é o estado que mais gasta da cota ainda seguido de _Minas Gerais_ e, assim como no caso anterior, o Centro-Oeste e o Norte gastam menos que as demais regiões.

### 4 - Quais os parlamentares que mais gastam com CEAP e quais os que menos gastam?

```{r}
parlamentar_rs <- ceap %>%
  group_by(nomeParlamentar) %>%
  summarise(total = sum(valorLíquido)) %>%
  filter(total > 1)
  

parlamentar_rs %>%
  filter(total >= quantile(total, 0.99)) %>%
  plot_ly(y = ~reorder(nomeParlamentar, total), x = ~total, type="scatter", mode="markers") %>%
  layout(margin = list(l = 150),
        yaxis = list(title = ""))

```

A visualização acima exibe os 1% dos fornecedores que __mais gastam__.

```{r}
parlamentar_rs %>%
  filter(total <= quantile(total, 0.01)) %>%
   plot_ly(y = ~reorder(nomeParlamentar, total), x = ~total, type="scatter", mode="markers") %>%
  layout(margin = list(l = 150),
         yaxis = list(title = ""))
```

O gráfico de pontos acima mostra os 1% fornecedores que __menos gastam__.

### 5 - Existe correlação entre a quantidade de gastos no exterior e o valor restituído da CEAP? 

```{r}
g <- ceap %>%
  filter(tipoDocumento %in% c(0, 1, 2)) %>%
  mutate(doc = ifelse(tipoDocumento == 2, 2, 1))

g1 <- g %>%
  filter(doc == 1) %>%
  group_by(nomeParlamentar) %>%
  summarise(total_brasil = sum(valorLíquido)) %>%
  inner_join( g %>%
                filter(doc == 2) %>%
                group_by(nomeParlamentar) %>%
                summarise(total_exterior = sum(valorLíquido))
                )

g1 %>%
  plot_ly(x=~total_brasil, y = ~total_exterior, type ="scatter", mode = "markers")

```

Não parece haver correlação entre o gasto no exterior e o gasto no Brasil.
